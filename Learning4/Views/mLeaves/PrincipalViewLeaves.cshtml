@model List<Learning4.Models.Leaves.LeavesMaster>

@{
    ViewData["Title"] = "PrincipalViewLeaves";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <div class="row">
        <h3>Approval of the Leave Requests</h3>
    </div>
    <div class="row">
        <div class="form-group">
            <label for="EmployeeId">Employee</label>
            <select id="EmployeeId" onchange="getdetails();" asp-items="ViewBag.Employees" class="form-control me-sm-2">
                <option value="">-- Select Employee --</option>
            </select>
        </div>
    </div>
    <div class="row">
        <table class="table" id="tblLeaves">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Employee Name</th>
                    <th>Leave Type</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Reason</th>
                    <th>Duration</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    var jq1 = jQuery.noConflict();
    jq1(document).ready(function () {
        getdetails();
    });

    function getdetails() {
        // Destroy existing DataTable before re-initializing
        if (jq1.fn.DataTable.isDataTable('#tblLeaves')) {
            jq1('#tblLeaves').DataTable().destroy();
            jq1('#tblLeaves tbody').empty();
        }

        jq1('#tblLeaves').DataTable({
            ajax: {
                url: '@Url.Action("GetAllLeavesByEmployeeID", "mLeaves")',
                type: 'POST',
                data: function (d) {
                    d.EmployeeId = jq1('#EmployeeId').val();
                },
                dataSrc: ''
            },
            columns: [
                { data: null, render: function (data, type, row, meta) { return meta.row + 1; } },
                { data: "employeeId" }, // Make sure your backend returns this property
                { data: "leaveTypeMaster.leaveType" }, // Dot notation supported
                { data: "leaveFrom", render: function (data) { return data ? new Date(data).toLocaleDateString() : ""; } },
                { data: "leaveTo", render: function (data) { return data ? new Date(data).toLocaleDateString() : ""; } },
                { data: "reason" },
                { data: "leaveDays" },
                { data: "statusMaster.status" },
                {
                    data: null,
                    render: function (data, type, row) {
                        if (row.statusMaster && row.statusMaster.status === "Pending") {
                            return `
                                <button class="btn btn-success btn-sm" onclick="approveLeave('${row.leaveId}')">Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectLeave('${row.leaveId}')">Reject</button>
                            `;
                        } else {
                            return row.statusMaster ? row.statusMaster.status : "";
                        }
                    }
                }
            ],
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search Leaves..."
            }
        });
    }

    // Example AJAX handlers for Approve/Reject
    function approveLeave(leaveId) {
        jq1.ajax({
            url: '@Url.Action("ApproveLeave", "mLeaves")',
            type: 'POST',
            data: { id: leaveId },
            success: function () {
                getdetails();
            }
        });
    }

    function rejectLeave(leaveId) {
        jq1.ajax({
            url: '@Url.Action("RejectLeave", "mLeaves")',
            type: 'POST',
            data: { id: leaveId },
            success: function () {
                getdetails();
            }
        });
    }
</script>
